<!--
# E2E Cases for EgressPolicy
- all case about check the `eip` will including tcp, udp and web socket

| Test Case ID | Title                                                                                                                                                                                                                                                                               | Priority | Smoke | Status | Others |
|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|-------|--------|--------|
| P00001       | Creating EgressPolicy fails when using an invalid `EgressIP`.                                                                                                                                                                                                                       | p2       | false | done   |        |
| P00002       | When `EgressGatewayName` is empty, creating cluster-level `EgressPolicy` should use the cluster's default `EgressGateway`, and check if `EgressPolicySpec.EgressGatewayName` and `EgressPolicyStatus` are updated correctly.                                                        | p2       | false | done   |        |
| P00003       | When `EgressGatewayName` is empty, creating tenant-level `EgressPolicy` should use the annotated `EgressGateway` if specified in the corresponding tenant's annotations; otherwise, use the cluster's default `EgressGateway`, and check if `EgressPolicySpec.EgressGatewayName` and `EgressPolicyStatus` are updated correctly. | p2       | false | done   |        |
| P00004       | Creating EgressPolicy fails when `EgressIP` is not within the `Ippools` range of the selected `egressGateway`.                                                                                                                                                                    | p2       | false | done   |        |
| P00005       | Creating EgressPolicy fails when `AppliedTo` is empty.                                                                                                                                                                                                                              | p2       | false | done   |        |
| P00006       | Creating `Policy` fails when both `AppliedTo.PodSubnet` and `AppliedTo.PodSelector` are set simultaneously.                                                                                                                                                                       | p2       | false | done   |        |
| P00007       | When only `AppliedTo.PodSubnet` is set, the exit IP of Pods matching the subnet should be `eip`, and Pods without a match should have non-`eip` exit IP; `endpointSlice` should not be created.                                                                          | p1       | true  | done   |        |
| P00008       | When `EgressIP` is empty and `AppliedTo.PodSelector` is set, `EgressPolicyStatus.Eip` and Pod exit IP should be the `defaultEIP` of the `egressGateway`, with `allocatorPolicy` as `default` and `useNodeIP` as `false`. Update `EgressGatewayStatus` as expected.              | p1       | true  | done   |        |
| P00009       | When `EgressIP` is empty, and `EgressIP.AllocatorPolicy` is set to round-robin, `EgressPolicyStatus` and `EgressGatewayStatus` should be updated correctly using an IP from `EgressGatewaySpec.Ippools`.                                                                     | p2       | false | done   |        |
| P00010       | When `EgressIP` is not empty, and `EgressIP.AllocatorPolicy` is set to round-robin, `EgressIP` should take effect. Check if `EgressPolicyStatus` and `EgressGatewayStatus` are updated correctly.                                                                              | p2       | false |        |        |
| P00011       | When `Policy.DestSubnet` is empty and accessing an external IP outside the range of IPs in `egressClusterInfo.Status`, Pod exit IP should be `eip`.                                                                                                                           | p1       | true  | done   |        |
| P00012       | When `Policy.DestSubnet` is empty and accessing an external IP within the range of IPs in `egressClusterInfo.Status`, Pod exit IP should not be `eip`.                                                                                                                       | p1       | true  | done   |        |
| P00013       | Set both `DestSubnet` and `PodSelector`. When accessing an external IP matching `DestSubnet`, Pod exit IP should be `eip`; when accessing an external IP not matching `DestSubnet`, Pod exit IP should not be `eip`.                                                        | p1       | true  | done   |        |
| P00014       | Edit `PodSelector` originally matching `DaemonSet-A` to match `DaemonSet-B`. `EgressEndpoint` should be updated from `DaemonSet-A` to `DaemonSet-B`, and exit IP for all Pods in `DaemonSet-A` should change from `eip` to non-`eip`, and for `DaemonSet-B` from non-`eip` to `eip`.              | p1       | true  | done   |        |
| P00015       | When `EgressIP.UseNodeIP` is `true`, and `EgressIP` is empty, creating `EgressPolicy` should set `EgressPolicyStatus.Eip` and `EgressGatewayStatus.Eips` to empty; Pod exit IP should be the node IP matching `egressGateway` `nodeSelector`.                                       | p1       | true  | done   |        |
| P00016       | When `EgressIP.UseNodeIP` is `true`, and `EgressIP` is empty, modifying `nodeSelector` of `EgressGateway` to match another node should update Pod exit IP to the new node's IP.                                                                                              | p1       | true  | done   |        |
| P00017       | Creating `EgressPolicy` fails when `EgressIP.UseNodeIP` is `true`, and `EgressIP` is not empty.                                                                                                                                                                                 | p2       | false | done   |        |
| P00018       | Editing `EgressIP` IP in `Policy` should result in an error.                                                                                                                                                                                                                        | p2       | false | done   |        |
| P00019       | Editing `EgressGatewayName` in `Policy` should result in an error.                                                                                                                                                                                                                 | p2       | false | done   |        |
| P00020       | When deleting `Policy`, `EgressGatewayStatus` and `EgressEndpoint` should be updated as expected, and Pod exit IP should change from `eip` to non-`eip`.                                                                                                                   | p1       | true  | done   |        |
| P00021       | `Namespace-level` Policy should only take effect in the specified namespace.                                                                                                                                                                                                       | p2       | false | done   |        |

-->
# EgressPolicy E2E 用例

- 用例中，所有有关 `eip` 校验的内容，都包含了 tcp，udp 和 web socket

| 用例编号   | 标题                                                                                                                                                                                                                                                                 | 优先级 | 冒烟    | 状态  | 其他  |
|--------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----|-------|-----|-----|
| P00001 | 当使用不合法的 `EgressIP`，创建 EgressPolicy 失败                                                                                                                                                                                                                        | p2  | false |  done |     |
| P00002 | 当 `EgressGatewayName` 为空时，创建集群级 `EgressPolicy` 时，会使用集群默认的 `EgressGateway`，检查 `EgressPolicySpec.EgressGatewayName` 及 `EgressPolicyStatus` 状态正确                                                                                                   | p2  | false |  done |     |
| P00003 | 当 `EgressGatewayName` 为空时，创建租户级 `EgressPolicy`时，如果对应租户注解上有相关 `EgressGateway` 的标注，则使用标注的 `EgressGatewa`，如果没有则使用集群默认的 `EgressGateway`，检查 `EgressPolicySpec.EgressGatewayName` 及 `EgressPolicyStatus` 状态正确                    | p2  | false | done |     |
| P00004 | 当 `EgressIP` 没有在 `Policy` 所选择的 `egressGateway` 的 `Ippools` 范围内，创建 EgressPolicy 会失败                                                                                                                                                                       | p2  | false | done |     |
| P00005 | 当 `AppliedTo` 为空时，创建 EgressPolicy 会失败                                                                                                                                                                                                                           | p2  | false | done |     |
| P00006 | 当同时设置 `AppliedTo.PodSubnet` 和 `AppliedTo.PodSelector` 时，创建 `Policy` 失败                                                                                                                                                                                        | p2  | false | done |     |
| P00007 | 当只设置了 `AppliedTo.PodSubnet`，与之匹配到的 `Pod` 的出口 IP 应是 `eip`，没有匹配到的 `Pod` 的出口 IP，应为非 `eip`，并且 `endpointSlice` 不会被创建                                                                                                                         | p1  | true  | done |     |
| P00008 | 当 `EgressIP` 为空并且设置了 `AppliedTo.PodSelector` 时，`Policy` 的 `EgressPolicyStatus.Eip` 和 Pod 的出口 IP 为 `egressGateway` 的 `defaultEIP`，`policy` 的 `allocatorPolicy` 为 `default`、`useNodeIP` 为 `false`， `EgressGatewayStatus` 会如预期更新                   | p1  | true  | done |     |
| P00009 | 当 `EgressIP` 的 IP 为空，并且 `EgressIP.AllocatorPolicy` 为轮询模式时， `eip` 会从 `EgressGatewaySpec.Ippools` 的 IP 中获取，检查 `EgressPolicyStatus` 和 `EgressGatewayStatus` 状态正确                                                                                    | p2  | false | done |     |
| P00010 | 当 `EgressIP` 的 IP 不为空，并且 `EgressIP.AllocatorPolicy` 为轮询模式时， `EgressIP` 会生效， 检查 `EgressPolicyStatus` 和 `EgressGatewayStatus` 状态正确                                                                                                                   | p2  | false | done |     |
| P00011 | 当 `Policy` 的 `DestSubnet` 为空并且访问的目的 IP 不在 `egressClusterInfo.Status` 中的 IP 列表范围之内时，<br/>Pod 的出口 IP 为 `eip`                                                                                                                                        | p1  | true  | done |     |
| P00012 | 当 `Policy` 的 `DestSubnet` 为空并且访问的目的 IP 在 `egressClusterInfo.Status` 中的 IP 列表范围之内时，<br/>Pod 的出口 IP 不为 `eip`                                                                                                                                        | p1  | true  | done |     |
| P00013 | 设置 `DestSubnet` 和 `PodSelector`, 当访问与 `DestSubnet` 匹配的外部 IP 时，Pod 的出口 IP 为 `eip`,<br/>当访问与 `DestSubnet` 不匹配的外部 IP 时， Pod 的出口 IP 为非 `eip`                                                                                                    | p1  | true  | done |     |
| P00014 | 编辑原本匹配 `DaemonSet-A` 的 `PodSelector` ，使之改为匹配 `DaemonSet-B`,<br/> `EgressEndpoint` 会由 `DaemonSet-A` 更新为 `DaemonSet-B` 的信息，<br/>并且 `DaemonSet-A` 所有 Pod 的 出口 IP 由 `eip` 改为非 `eip`，`DaemonSet-B` 所有 Pod 的出口 IP 由非 `eip` 改为 `eip`        | p1  | true  | done |     |
| P00015 | 当 `EgressIP.UseNodeIP` 为 `true` 并且 `EgressIP` 的 IP 为空时，创建 `EgressPolicy`，<br/>`EgressPolicyStatus.Eip` 和 `EgressGatewayStatus.Eips` 的 IP 应该为空，并且 Pod 的出口 IP 为 egressGateway `nodeSelector` 所匹配的 node 的 IP                                       | p1  | true  | done |     |
| P00016 | 当 `EgressIP.UseNodeIP` 为 `true` 并且 `EgressIP` 的 IP 为空时，<br/>修改EgressGateway 的 `nodeSelector` 匹配另一个节点，并且 Pod 的出口 IP 为 egressGateway `nodeSelector` 新匹配的 node 的 IP                                                                               | p1  | true  | done |     |
| P00017 | 当 `EgressIP.UseNodeIP` 为 `true` 并且 `EgressIP` 的 IP 不为空时，创建 `EgressPolicy` 会失败                                                                                                                                                                               | p2  | false | done |     |
| P00018 | 当编辑 Policy 的 `EgressIP` 的 IP 时，会报错                                                                                                                                                                                                                              | p2  | false | done |     |
| P00019 | 当编辑 Policy 的 `EgressGatewayName` 时，会报错                                                                                                                                                                                                                           | p2  | false | done |     |
| P00020 | 当删除 Policy，`EgressGatewayStatus` 和 `EgressEndpoint` 将如预期更新，并且 Pod 的出口 IP 由 `eip` 改为非 `eip`                                                                                                                                                             | p1  | true  | done |     |
| P00021 | `namespace-level` 的 Policy 只生效在它所指定的命名空间                                                                                                                                                                                                                     | p2  | false | done |     |